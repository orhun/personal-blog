<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <meta property="og:type" content="website" />
      <meta property="og:url" content="https://blog.orhun.dev"/>
      
      <meta property="og:title" content="Fully Automated Releases for Rust Projects - Orhun&#x27;s Blog" />
      
      <meta property="og:image" content="https://blog.orhun.dev/crow.png" />
      
      <meta name="description" content="FOSS • Linux • Programming" />
      <meta property="og:description" content="FOSS • Linux • Programming"/>
      

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
      <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
      <link rel="manifest" href="/favicon/site.webmanifest">

      <script async src="https://umami.orhun.dev/script.js" data-website-id="56ca5ca7-ba9f-416e-8bee-a132c155d56b"></script>

      <link rel="stylesheet" href="https://unpkg.com/applause-button/dist/applause-button.css" />
      <script src="https://unpkg.com/applause-button/dist/applause-button.js"></script>

      
      <title>Fully Automated Releases for Rust Projects - Orhun&#x27;s Blog</title>
      
      <link rel="alternate" type="application/rss+xml" title="Orhun&#x27;s Blog RSS Feed" href="https://blog.orhun.dev/rss.xml" />

      
          <link rel="stylesheet" href="https://blog.orhun.dev/site.css">
      

      
      
    </head>

    <body class="hack dark main container">
        
    
        
                
                    <header>
                    <nav itemscope itemtype="http://schema.org/SiteNavigationElement" class="nav-flex">
                        
                            <a itemprop="url"
                              class=""
                              href="https://blog.orhun.dev">
                                <span itemprop="name">Home</span>
                            </a>
                        
                            <a itemprop="url"
                              class=""
                              href="https://blog.orhun.dev/categories">
                                <span itemprop="name">Categories</span>
                            </a>
                        
                            <a itemprop="url"
                              class=""
                              href="https://github.com/orhun/personal-blog">
                                <span itemprop="name">Source</span>
                            </a>
                        
                            <a itemprop="url"
                              class=""
                              href="https://github.com/orhun">
                                <span itemprop="name">GitHub</span>
                            </a>
                        
                            <a itemprop="url"
                              class=""
                              href="https://donate.orhun.dev">
                                <span itemprop="name">Donate</span>
                            </a>
                        
                            <a itemprop="url"
                              class=""
                              href="https://blog.orhun.dev/rss.xml">
                                <span itemprop="name">RSS</span>
                            </a>
                        
                            <a itemprop="url"
                              class=""
                              href="https://orhun.dev">
                                <span itemprop="name">About</span>
                            </a>
                        
                        <div class="search-container">
                            <input type="text" id="search" placeholder="Search...">
                            <div class="search-results">
                                <div class="search-results__items"></div>
                            </div>
                        </div>
                    </nav>
                    </header>
                
            
    

<article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">Fully Automated Releases for Rust Projects</h1>
        <span class="muted">
    <svg style="margin-bottom:-3px" class="i-clock" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <circle cx="16" cy="16" r="14"/>
        <path d="M16 8 L16 16 20 20"/>
    </svg>
    <span>14 minute read</span>
    <svg style="margin-bottom: -3px" class="i-edit" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z"/>
    </svg>

    Published: 2023-10-24
</span>
    </header>
    <div itemprop="articleBody">
      <p>Here is how you can publish a Rust project with a single click of a button and automate <em>everything</em>.</p>
<span id="continue-reading"></span><center>
<img alt="https://xkcd.com/1319/" src="/xkcd1319.png" width="60%"/>
</center>
<p>Imagine a developer named <em>nuhro</em>. He wrote his first ever Rust program and it is happily running on his machine. He also sent a binary/exe to a couple of trusting friends and they all loved the program after blindly executing it. Good vibes!</p>
<p>Then one day, he decided to share this small program with the world (AKA Reddit). For that, he realized he needed to <em>release</em> the program. Otherwise, how are the residents of the internet (who might be using different OSes/platforms) going to install/run the program, right?</p>
<blockquote>
<p><em>No worries, there must be an easy way of releasing Rust crates and automating this stuff.</em></p>
</blockquote>
<p>he thought.</p>
<p>And yeah, this was <em>me</em> back in 2019 when I published my <a href="https://github.com/orhun/kmon">first Rust project</a> and automated the release process with a snatched-off GitHub Actions workflow from <a href="https://github.com/BurntSushi/ripgrep/blob/master/.github/workflows/release.yml"><code>ripgrep</code></a> o_O</p>
<p>Coming back to today, if you want to release a Rust project, it is likely that you will come across the following Rust release tools:</p>
<ul>
<li><a href="https://github.com/crate-ci/cargo-release"><code>cargo-release</code></a>: everything about releasing a rust crate.</li>
<li><a href="https://github.com/Byron/cargo-smart-release"><code>cargo-smart-release</code></a>: release complex cargo-workspaces automatically with changelog generation.</li>
<li><a href="https://github.com/paritytech/cargo-unleash"><code>cargo-unleash</code></a>: release automatisation tooling for massiv mono-repos.</li>
</ul>
<p>We can list other tools here, but in a nutshell, all we want to do is:</p>
<ol>
<li>Make sure the project is in a <em>state for the release</em>. This might include updated version/changelog/dependencies.</li>
<li>Tag the new release.</li>
<li>Publish the new version on the various platforms (crates.io, GitHub, etc.)</li>
</ol>
<p><strong>Q</strong>: Okay okay, but aren't you overcomplicating things? I mean... just update the version in <code>Cargo.toml</code> and run <code>cargo publish</code>.</p>
<p><strong>A</strong>: That's fair, but how about binary releases? As someone who has spent a good amount of time automating NPM releases, I would say this might not be <em>that easy</em> for every project.</p>
<p><strong>Q</strong>: I still think you can just copy/paste a GitHub Actions workflow file from another project and adopt it.</p>
<p><strong>A</strong>: It is still too much manual work + release process is still not fully automated - you need to create tags/update changelog etc. Besides, your name is "<strong>Q</strong>" but you are not really asking questions anymore and just rambling. Maybe it is time to introduce you as a new character in these blog posts.</p>
<p><strong>Q</strong>: It do be like that sometimes.</p>
<p>Anyhoo, it seems like we are going to end up all over the place if we were to over-plan the release process. I wish there was a more standardized way...</p>
<p>In fact, there is!</p>
<hr />
<h2 id="the-potent-elixir-sparkles">The Potent Elixir ✨</h2>
<p>Here, we are going to mix up the most powerful tools to come up with the <em>witch's concoction</em>, the ultimate way of publishing Rust crates. Some may call it the toxic brew that might poison one due to over-automation. Some may call it the one-way ticket to the automation hell. Some may--</p>
<p>*ahem*</p>
<p>So here is the list of tools we are going to utilize:</p>
<table><thead><tr><th><strong>Tool</strong></th><th><strong>Description</strong></th><th><strong>Function</strong></th></tr></thead><tbody>
<tr><td><a href="https://git-cliff.org"><code>git-cliff</code></a></td><td>A highly customizable Changelog Generator.</td><td>Automates the changelog generation.</td></tr>
<tr><td><a href="https://release-plz.ieni.dev"><code>release-plz</code></a></td><td>Publish Rust crates from CI with a Release PR.</td><td>Handles dependency updates, version management, and crates.io release.</td></tr>
<tr><td><a href="https://opensource.axo.dev/cargo-dist/"><code>cargo-dist</code></a></td><td>Shippable application packaging for Rust.</td><td>Creates GitHub releases and packaging for various platforms.</td></tr>
<tr><td><a href="https://github.com/dependabot"><code>Dependabot</code></a></td><td>Automated dependency updates built into GitHub.</td><td>Updates the Rust and GitHub Actions dependencies.</td></tr>
<tr><td><a href="https://mergify.com/"><code>Mergify</code></a></td><td>Automated CI/CD tool for optimization.</td><td>Automatically merges the <code>Dependabot</code> pull requests.</td></tr>
</tbody></table>
<p>With minimal tweaks, we can make these tools work seamlessly integrated with each other and at the end of the day what we have to do is just click a button to trigger a new release. In other words, the best part about this release flow is that almost everything is handled in the CI i.e. GitHub Actions thus we don't even move a finger.</p>
<p><img src="/automated-rust-releases.png" alt="diagram" /></p>
<p>Now, let's get to work!</p>
<hr />
<h2 id="setting-things-up-gear">Setting Things Up ⚙️</h2>
<h3 id="git-cliff"><strong>git-cliff</strong></h3>
<p><a href="https://github.com/orhun/git-cliff"><code>git-cliff</code></a> is one of my big projects and it is widely used in the Rust ecosystem for automating the changelog generation.</p>
<blockquote>
<p><a href="https://github.com/orhun/git-cliff"><strong>git-cliff</strong></a> is a command-line tool (written in <a href="https://www.rust-lang.org/">Rust</a>) that provides a highly customizable way to generate changelogs from git history. It supports using <a href="/docs/configuration#commit_parsers">custom regular expressions</a> to alter changelogs which are mostly based on <a href="/docs/configuration#conventional_commits">conventional commits</a>. With a single <a href="/docs/configuration">configuration file</a>, a wide variety of formats can be applied for a changelog, thanks to the Jinja2/Django-inspired <a href="/docs/category/templating">template engine</a>. More information and examples can be found in the <a href="https://github.com/orhun/git-cliff">GitHub repository</a>.</p>
</blockquote>
<p>For our changelog format, we can simply go with the default configuration which outputs something like the following:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="background-color:#171717;color:#616161;"># Changelog
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">All notable changes to this project will be documented in this file.
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;">## [unreleased]
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;">### Documentation
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">- Add link to emacs package support git-cliff (#307)
</span></code></pre>
<p>For this configuration, first, we should install <code>git-cliff</code>:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">cargo install git-cliff</span><span style="font-style:italic;color:#8aa6c1;"> --locked
</span></code></pre>
<p>Then we can initialize it as follows:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">git cliff</span><span style="font-style:italic;color:#8aa6c1;"> --init
</span></code></pre>
<p>This will create <code>cliff.toml</code> in the current directory and you can commit it in the root directory of your repo for <code>release-plz</code> to pick it up.</p>
<p>If you want to generate a fancier changelog, you can look at the <a href="https://git-cliff.org/docs/templating/examples">examples</a> or use the <a href="https://github.com/orhun/git-cliff/blob/main/cliff.toml">configuration that <code>git-cliff</code> uses</a> which corresponds to the following:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ git cliff
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># Changelog
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">All notable changes to this project will be documented in this file.
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;">## [unreleased]
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;">### 📚 Documentation
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">- _(readme)_ Add link to emacs package support git-cliff (</span><span style="color:#80d500;">[</span><span style="color:#cccccc;">#307</span><span style="color:#80d500;">]</span><span style="color:#cccccc;">(https://github.com/orhun/git-cliff/issues/307)) - (</span><span style="color:#80d500;">[</span><span style="color:#cccccc;">fa471c7</span><span style="color:#80d500;">]</span><span style="color:#cccccc;">(https://github.com/orhun/git-cliff/commit/fa471c7178dce184ca6fe5bbb24b9c2db96d68ce))
</span></code></pre>
<p>Great, now we are ready to set up the actual releaser tool!</p>
<hr />
<h3 id="release-plz"><strong>release-plz</strong></h3>
<blockquote>
<p><a href="https://release-plz.ieni.dev">release-plz</a> creates a fully automated release pipeline, allowing you to easily release changes more frequently, without the fear of doing typos or other subtle manual mistakes you can make when releasing from your terminal.</p>
</blockquote>
<p>Unlike <code>git-cliff</code>, we don't actually need to install <code>release-plz</code> as a command-line tool. It is because <code>release-plz</code> runs from the CI (GitHub Actions) and we are not doing anything locally for the releases. However, we still need to tweak some things regarding how we want to release our project.</p>
<p>For configuring <code>release-plz</code>, create <code>release-plz.toml</code> with the following contents at the root of your repository:</p>
<pre data-lang="toml" style="background-color:#191919;color:#ffffff;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#cccccc;">[workspace]
</span><span style="background-color:#171717;color:#616161;"># path of the git-cliff configuration</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">changelog_config </span><span style="color:#cccccc;">= </span><span style="color:#ffd700;">&quot;cliff.toml&quot;
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># enable changelog updates</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">changelog_update </span><span style="color:#cccccc;">= </span><span style="color:#80d500;">true
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># update dependencies with `cargo update`</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">dependencies_update </span><span style="color:#cccccc;">= </span><span style="color:#80d500;">true
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># create tags for the releases</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">git_tag_enable </span><span style="color:#cccccc;">= </span><span style="color:#80d500;">true
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># disable GitHub releases</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">git_release_enable </span><span style="color:#cccccc;">= </span><span style="color:#80d500;">false
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># labels for the release PR</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">pr_labels </span><span style="color:#cccccc;">= [</span><span style="color:#ffd700;">&quot;release&quot;</span><span style="color:#cccccc;">]
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># disallow updating repositories with uncommitted changes</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">allow_dirty </span><span style="color:#cccccc;">= </span><span style="color:#80d500;">false
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># disallow packaging with uncommitted changes</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">publish_allow_dirty </span><span style="color:#cccccc;">= </span><span style="color:#80d500;">false
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># disable running `cargo-semver-checks`</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">semver_check </span><span style="color:#cccccc;">= </span><span style="color:#80d500;">false
</span></code></pre>
<p>The important options here are:</p>
<ul>
<li><code>changelog_config</code>: should point out to the <code>git-cliff</code> configuration we created in the previous section.</li>
<li><code>dependencies_update</code>: setting this to <code>true</code> means that you want to run <code>cargo update</code> before each release. Enabling this for updating the transitive dependencies wouldn't hurt since we will already be updating the main dependencies with Dependabot in future steps.</li>
<li><code>git_tag_enable</code>: set this to <code>true</code> to create a tag for the new releases.</li>
<li><code>git_release_enable</code>: make sure to set this to <code>false</code> since we don't want <code>release-plz</code> to create a GitHub release for us since that part will be handled by <code>cargo-dist</code>.</li>
</ul>
<p>As for the next step, we should create the <em>actual</em> release automation that is responsible for running <code>release-plz</code> for each commit pushed to the repository and creating a "release PR".</p>
<p><strong>Q</strong>: A release PR?</p>
<p><strong>A</strong>: Release PR is a pull request that represents the next release and contains the necessary changes such as version bumps and changelog updates.</p>
<center>
<p><img src="/release-pr.png" alt="release PR" /></p>
<p><a href="https://github.com/orhun/daktilo/pull/51">https://github.com/orhun/daktilo/pull/51</a></p>
</center>
<p>After you merge the release PR, <code>release-plz</code> detects that there is a version change in <code>Cargo.toml</code> and runs <code>cargo publish</code> to release the new version on <a href="https://crates.io">crates.io</a>.</p>
<p><strong>Q</strong>: Ah, so we probably need to set up secrets for the publish token, etc., right?</p>
<p>Yes! And a few permissions, too. You can check out <a href="https://release-plz.ieni.dev/docs/github"><code>release-plz</code> documentation</a> for more detailed information but here is a quick summary:</p>
<p>1. Change "Workflow permissions" to allow GitHub Actions to create and approve pull requests in Repository &gt; Settings &gt; Actions &gt; General.</p>
<center>
<p><img src="/workflow-permissions.png" alt="workflow permissions" /></p>
</center>
<p>2. Create a new PAT (Personal Access Token) (either fine-grained or classic) with correct repository permissions and add it to the repository as a secret named <code>RELEASE_PLZ_TOKEN</code>.</p>
<center>
<p><img src="/fine-grained-token.png" alt="fine grained token" /></p>
</center>
<p>3. On crates.io, generate a new token with <code>publish-new</code> and <code>publish-update</code> permissions and add it to the repository as a secret named <code>CARGO_REGISTRY_TOKEN</code>.</p>
<center>
<p><img src="/crates-io-token.png" alt="crates.io token" /></p>
</center>
<p>4. We can finally create our GitHub Actions workflow in <code>.github/workflows/release-plz.yml</code></p>
<pre data-lang="yml" style="background-color:#191919;color:#ffffff;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#80d500;">name</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">Continuous Deployment
</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">on</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">  </span><span style="color:#80d500;">push</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">branches</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">      - </span><span style="color:#ffd700;">main
</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">jobs</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">  </span><span style="color:#80d500;">release-plz</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">name</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">Release-plz
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">runs-on</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">ubuntu-latest
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">steps</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">      - </span><span style="color:#80d500;">name</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">Checkout repository
</span><span style="color:#cccccc;">        </span><span style="color:#80d500;">uses</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">actions/checkout@v4
</span><span style="color:#cccccc;">        </span><span style="color:#80d500;">with</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">          </span><span style="color:#80d500;">fetch-depth</span><span style="color:#cccccc;">: </span><span style="color:#eddd5a;">0
</span><span style="color:#cccccc;">          </span><span style="color:#80d500;">token</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">${{ secrets.RELEASE_PLZ_TOKEN }}
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">      - </span><span style="color:#80d500;">name</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">Install Rust toolchain
</span><span style="color:#cccccc;">        </span><span style="color:#80d500;">uses</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">dtolnay/rust-toolchain@stable
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">      - </span><span style="color:#80d500;">name</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">Run release-plz
</span><span style="color:#cccccc;">        </span><span style="color:#80d500;">uses</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">MarcoIeni/release-plz-action@v0.5
</span><span style="color:#cccccc;">        </span><span style="color:#80d500;">env</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">          </span><span style="color:#80d500;">GITHUB_TOKEN</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">${{ secrets.RELEASE_PLZ_TOKEN }}
</span><span style="color:#cccccc;">          </span><span style="color:#80d500;">CARGO_REGISTRY_TOKEN</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">${{ secrets.CARGO_REGISTRY_TOKEN }}
</span></code></pre>
<p>To break it down:</p>
<ul>
<li>We are cloning the entire git history with <code>fetch-depth: 0</code>, which is necessary to determine the next version and build the changelog.</li>
<li>We are installing Rust stable ('cause why not?!)</li>
<li>As the last step, we are running <code>release-plz</code>, heck yea!</li>
</ul>
<p><strong>Q</strong>: Whoa whoa whoa hey hey hey, what's up with <code>GITHUB_TOKEN: ${{ secrets.RELEASE_PLZ_TOKEN }}</code>? Just use <code>${{ secrets.GITHUB_TOKEN }}</code> bro, which is defined as default for each repository.</p>
<p><strong>A</strong>: Good question! If you use <code>GITHUB_TOKEN</code> then it means that you are going to authenticate on behalf of GitHub Actions.</p>
<p><strong>Q</strong>: So, what's wrong with that?</p>
<p><strong>A</strong>: Well, workflows that are triggered by <code>on: push: tags</code> <em>won't run</em> if the tag is created by GitHub Actions. So we are using a personal access token which is a way of saying "Dear GitHub Actions, I am running <code>release-plz</code> and it is ME who is creating a tag so please run the further workflows". Also, this way we don't need to specify workflow permissions via <code>permissions:</code> key. You can read more about it <a href="https://release-plz.ieni.dev/docs/github/token">here</a>.</p>
<p>Now we are simply ready to work on our project as usual and <code>release-plz</code> will create a release PR for our changes and we can merge it to create a new release when we are ready!</p>
<p><strong>Q</strong>: What if I want to run/test <code>release-plz</code> locally though?</p>
<p><strong>A</strong>: You can if you want! The release PR is just the output of <code>release-plz update</code> command so you can run it locally and see what has changed in terms of changelog etc. Also, if you want to create a PR from the command-line you can simply run <code>release-plz release-pr</code>!</p>
<hr />
<h3 id="cargo-dist"><strong>cargo-dist</strong></h3>
<blockquote>
<p><a href="https://opensource.axo.dev/cargo-dist/">cargo-dist</a> makes distributing binaries easier by breaking the process down into multiple steps such as plan, build, publish and announce.</p>
</blockquote>
<p>It is simply a tool for creating this beautiful release page along with binary artifacts and installers:</p>
<center>
<p><img src="/cargo-dist-release.png" alt="cargo-dist release" /></p>
<p><a href="https://github.com/orhun/daktilo/releases/tag/v0.4.0">https://github.com/orhun/daktilo/releases/tag/v0.4.0</a></p>
</center>
<p>Similar to <code>release-plz</code>, <code>cargo-dist</code> is a tool that we are not going to use locally but run from the CI instead. However, it is required to be installed to set up the CI (for itself) for the first time.</p>
<p>So let's start by installing <code>cargo-dist</code>:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">cargo install cargo-dist</span><span style="font-style:italic;color:#8aa6c1;"> --locked
</span></code></pre>
<p>You can also use <code>cargo-dist-installer</code> to install <code>cargo-dist</code> (i.e. the binary installer) if you wish:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">cargo_dist_version</span><span>=</span><span style="color:#ffd700;">&quot;0.3.1&quot;
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">curl</span><span style="font-style:italic;color:#8aa6c1;"> --proto </span><span style="color:#ffd700;">&#39;=https&#39;</span><span style="font-style:italic;color:#8aa6c1;"> --tlsv1</span><span style="color:#cccccc;">.2</span><span style="font-style:italic;color:#8aa6c1;"> -LsSf</span><span style="color:#cccccc;"> https://github.com/axodotdev/cargo-dist/releases/download/v{version}/cargo-dist-installer.sh </span><span>| </span><span style="color:#cccccc;">sh
</span></code></pre>
<p>We will also have an installer as shown above after <code>cargo dist</code> does its magic.</p>
<p><strong>Q</strong>: Magic?</p>
<p><strong>A</strong>: Yeah, this:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">cargo dist init
</span></code></pre>
<center>
<p><img src="/cargo-dist.gif" alt="cargo-dist in action" /></p>
</center>
<p><strong>Q</strong>: Woah, what happened?</p>
<p>The command above generates <code>.github/workflows/release.yml</code> file for handling the GitHub releases. Also, it adds the following section to your project's <code>Cargo.toml</code>:</p>
<pre data-lang="toml" style="background-color:#191919;color:#ffffff;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="background-color:#171717;color:#616161;"># The profile that &#39;cargo dist&#39; will build with</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">[profile.dist]
</span><span style="color:#80d500;">inherits </span><span style="color:#cccccc;">= </span><span style="color:#ffd700;">&quot;release&quot;
</span><span style="color:#80d500;">lto </span><span style="color:#cccccc;">= </span><span style="color:#ffd700;">&quot;thin&quot;
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># Config for &#39;cargo dist&#39;</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">[workspace.metadata.dist]
</span><span style="background-color:#171717;color:#616161;"># The preferred cargo-dist version to use in CI (Cargo.toml SemVer syntax)</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">cargo-dist-version </span><span style="color:#cccccc;">= </span><span style="color:#ffd700;">&quot;0.3.1&quot;
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># CI backends to support</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">ci </span><span style="color:#cccccc;">= [</span><span style="color:#ffd700;">&quot;github&quot;</span><span style="color:#cccccc;">]
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># The installers to generate for each app</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">installers </span><span style="color:#cccccc;">= [</span><span style="color:#ffd700;">&quot;shell&quot;</span><span style="color:#cccccc;">, </span><span style="color:#ffd700;">&quot;powershell&quot;</span><span style="color:#cccccc;">]
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># Target platforms to build apps for (Rust target-triple syntax)</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">targets </span><span style="color:#cccccc;">= [
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;x86_64-unknown-linux-gnu&quot;</span><span style="color:#cccccc;">,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;aarch64-apple-darwin&quot;</span><span style="color:#cccccc;">,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;x86_64-apple-darwin&quot;</span><span style="color:#cccccc;">,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;x86_64-pc-windows-msvc&quot;</span><span style="color:#cccccc;">,
</span><span style="color:#cccccc;">]
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># Publish jobs to run in CI</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">pr-run-mode </span><span style="color:#cccccc;">= </span><span style="color:#ffd700;">&quot;upload&quot;
</span></code></pre>
<p>You can update this configuration to easily configure <code>cargo-dist</code> and tweak your release settings.</p>
<p><strong>Q</strong>: What about new releases/breaking changes of <code>cargo-dist</code>? Do I need to remove the configuration and start over?</p>
<p><strong>A</strong>: You can simply run <code>cargo dist init</code> again to re-generate the release configuration!</p>
<p><strong>Q</strong>: Cool! Does <code>cargo-dist</code> check if the workflow file is up-to-date? What if I want to make changes to the generated GitHub Actions workflow (such as installing Linux dependencies)?</p>
<p><strong>A</strong>: Simply set the following values in the configuration to avoid an "out of date" warning:</p>
<pre data-lang="toml" style="background-color:#191919;color:#ffffff;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#cccccc;">[workspace.metadata.dist]
</span><span style="color:#cccccc;">
</span><span style="background-color:#171717;color:#616161;"># Ignore out-of-date contents</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">allow-dirty </span><span style="color:#cccccc;">= [</span><span style="color:#ffd700;">&quot;ci&quot;</span><span style="color:#cccccc;">]
</span></code></pre>
<p><strong>Q</strong>: How can I test <code>cargo-dist</code> locally?</p>
<p><strong>A</strong>: Easy:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ cargo dist plan
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">announcing v0.1.0
</span><span style="color:#cccccc;">  automated-rust-releases 0.1.0
</span><span style="color:#cccccc;">    automated-rust-releases-installer.sh
</span><span style="color:#cccccc;">    automated-rust-releases-installer.ps1
</span><span style="color:#cccccc;">    automated-rust-releases-aarch64-apple-darwin.tar.xz
</span><span style="color:#cccccc;">      [bin] automated-rust-releases
</span><span style="color:#cccccc;">      [misc] LICENSE-MIT
</span><span style="color:#cccccc;">      [checksum] automated-rust-releases-aarch64-apple-darwin.tar.xz.sha256
</span><span style="color:#cccccc;">    automated-rust-releases-x86_64-apple-darwin.tar.xz
</span><span style="color:#cccccc;">      [bin] automated-rust-releases
</span><span style="color:#cccccc;">      [misc] LICENSE-MIT
</span><span style="color:#cccccc;">      [checksum] automated-rust-releases-x86_64-apple-darwin.tar.xz.sha256
</span><span style="color:#cccccc;">    automated-rust-releases-x86_64-pc-windows-msvc.zip
</span><span style="color:#cccccc;">      [bin] automated-rust-releases.exe
</span><span style="color:#cccccc;">      [misc] LICENSE-MIT
</span><span style="color:#cccccc;">      [checksum] automated-rust-releases-x86_64-pc-windows-msvc.zip.sha256
</span><span style="color:#cccccc;">    automated-rust-releases-x86_64-unknown-linux-gnu.tar.xz
</span><span style="color:#cccccc;">      [bin] automated-rust-releases
</span><span style="color:#cccccc;">      [misc] LICENSE-MIT
</span><span style="color:#cccccc;">      [checksum] automated-rust-releases-x86_64-unknown-linux-gnu.tar.xz.sha256
</span></code></pre>
<p>And run <code>cargo dist build</code> if you actually want to build the artifacts. Also, if you set <code>pr-run-mode</code> to <code>upload</code> in the configuration, then the artifacts will be built and uploaded as <code>artifacts.zip</code> to the related commit on GitHub.</p>
<center>
<p><img src="/cargo-dist-artifacts.png" alt="cargo-dist artifacts" /></p>
</center>
<p>Now we are ready to build artifacts and release them on GitHub! There are a couple of steps left until we create a release and showcase everything.</p>
<hr />
<h3 id="dependabot"><strong>Dependabot</strong></h3>
<p><a href="https://github.com/dependabot"><code>Dependabot</code></a> is a tool built into GitHub for automatically updating a project's dependencies via creating pull requests.</p>
<p>We can simply configure it by creating <code>.github/dependabot.yml</code>:</p>
<pre data-lang="yml" style="background-color:#191919;color:#ffffff;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#80d500;">version</span><span style="color:#cccccc;">: </span><span style="color:#eddd5a;">2
</span><span style="color:#80d500;">updates</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">  </span><span style="background-color:#171717;color:#616161;"># Maintain dependencies for Cargo
</span><span style="color:#cccccc;">  - </span><span style="color:#80d500;">package-ecosystem</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">cargo
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">directory</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;/&quot;
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">schedule</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">      </span><span style="color:#80d500;">interval</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">daily
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">open-pull-requests-limit</span><span style="color:#cccccc;">: </span><span style="color:#eddd5a;">10
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">  </span><span style="background-color:#171717;color:#616161;"># Maintain dependencies for GitHub Actions
</span><span style="color:#cccccc;">  - </span><span style="color:#80d500;">package-ecosystem</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">github-actions
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">directory</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;/&quot;
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">schedule</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">      </span><span style="color:#80d500;">interval</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">daily
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">open-pull-requests-limit</span><span style="color:#cccccc;">: </span><span style="color:#eddd5a;">10
</span></code></pre>
<p>Now <code>Dependabot</code> will start creating pull requests for Rust/GitHub Actions dependencies when they become out-of-date:</p>
<center>
<p><img src="/dependabot-pr.png" alt="dependabot PR" /></p>
<p><a href="https://github.com/orhun/systeroid/pull/141">https://github.com/orhun/systeroid/pull/141</a></p>
</center>
<hr />
<h3 id="mergify"><strong>Mergify</strong></h3>
<blockquote>
<p><a href="https://mergify.com/"><code>Mergify</code></a> is a CI/CD pipeline optimizer that manages your pull request, automates your GitHub workflow, and optimizes your CI costs.</p>
</blockquote>
<p>We will be using <code>Mergify</code> to:</p>
<ol>
<li>Automatically merge <code>Dependabot</code> pull requests.</li>
<li>Update to the latest <code>main</code> branch for pull requests.</li>
</ol>
<p>Let's create the configuration in <code>.github/mergify.yml</code>:</p>
<pre data-lang="yml" style="background-color:#191919;color:#ffffff;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#80d500;">pull_request_rules</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">  - </span><span style="color:#80d500;">name</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">Automatic merge for Dependabot pull requests
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">conditions</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">      - </span><span style="color:#ffd700;">author=dependabot[bot]
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">actions</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">      </span><span style="color:#80d500;">merge</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">        </span><span style="color:#80d500;">method</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">squash
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">  - </span><span style="color:#80d500;">name</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">Automatic update to the main branch for pull requests
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">conditions</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">      - </span><span style="color:#ffd700;">-conflict </span><span style="background-color:#171717;color:#616161;"># skip PRs with conflicts
</span><span style="color:#cccccc;">      - </span><span style="color:#ffd700;">-draft </span><span style="background-color:#171717;color:#616161;"># skip GH draft PRs
</span><span style="color:#cccccc;">      - </span><span style="color:#ffd700;">-author=dependabot[bot] </span><span style="background-color:#171717;color:#616161;"># skip dependabot PRs
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">actions</span><span style="color:#cccccc;">:
</span><span style="color:#cccccc;">      </span><span style="color:#80d500;">update</span><span style="color:#cccccc;">:
</span></code></pre>
<p>Then, we need to create an account on https://mergify.com, setup GitHub integration (Integrations &gt; GitHub &gt; Configure) and add our repository:</p>
<center>
<p><img src="/mergify-dashboard.png" alt="mergify dashboard" /></p>
</center>
<p>Lastly, we need to enforce a GitHub repository branch protection rule by enabling <code>Require status checks to pass</code> and adding a check for <code>Mergify Merge Protections</code> (see the <a href="https://docs.mergify.com/merge-protections/setup/">Mergify documentation</a>).</p>
<p>Now <code>Mergify</code> will start to process the open pull requests:</p>
<center>
<p><img src="/mergify-event-logs.png" alt="mergify event logs" /></p>
</center>
<p>The <code>Dependabot</code> pull requests are now merged automatically! 🎉</p>
<center>
<p><img src="/mergify-merge.png" alt="mergify merge" /></p>
</center>
<hr />
<h2 id="let-s-create-releases-rocket">Let's Create Releases 🚀</h2>
<p>All the code/configuration is available here: <a href="https://github.com/orhun/automated-rust-releases"><strong>https://github.com/orhun/automated-rust-releases</strong></a></p>
<p><code>release-plz</code> already created a PR for us:</p>
<center>
<p><img src="/automated-rust-releases1.png" alt="release PR" /></p>
<p><a href="https://github.com/orhun/automated-rust-releases/pull/1">https://github.com/orhun/automated-rust-releases/pull/1</a></p>
</center>
<p><code>cargo-dist</code> checks also pass. Let's click merge and create a release:</p>
<center>
<p><img src="/automated-rust-releases2.png" alt="release PR status" /></p>
</center>
<p>After the merge, <code>release-plz</code> picks up the new version from <code>Cargo.toml</code> and pushes the new version to <code>crates.io</code>:</p>
<center>
<p><img src="/automated-rust-releases3.png" alt="release-plz CI" /></p>
</center>
<p><code>release-plz</code> also creates a new tag which triggers <code>cargo-dist</code>:</p>
<center>
<p><img src="/automated-rust-releases4.png" alt="cargo-dist CI" /></p>
</center>
<p><code>cargo-dist</code> builds the artifacts and uploads them to the GitHub release:</p>
<center>
<p><img src="/automated-rust-releases5.png" alt="release" /></p>
<p><a href="https://github.com/orhun/automated-rust-releases/releases/tag/v0.1.1">https://github.com/orhun/automated-rust-releases/releases/tag/v0.1.1</a></p>
</center>
<p>As you can see <code>cargo-dist</code> also parses the changelog (which is generated by <code>git-cliff</code>) and adds it to the release. (Please note that you actually need to create CHANGELOG.md file at the root of your repository for this to work.)</p>
<p>Let's try out the installer for the heck of it:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ curl</span><span style="font-style:italic;color:#8aa6c1;"> --proto </span><span style="color:#ffd700;">&#39;=https&#39;</span><span style="font-style:italic;color:#8aa6c1;"> --tlsv1</span><span style="color:#cccccc;">.2</span><span style="font-style:italic;color:#8aa6c1;"> -LsSf</span><span style="color:#cccccc;"> https://github.com/orhun/automated-rust-releases/releases/download/v0.1.1/automated-rust-releases-installer.sh </span><span>| </span><span style="color:#cccccc;">sh
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">downloading automated-rust-releases 0.1.1 x86_64-unknown-linux-gnu
</span><span style="color:#cccccc;">installing to /home/orhun/.cargo/bin
</span><span style="color:#cccccc;">  automated-rust-releases
</span><span style="color:#cccccc;">everything</span><span style="color:#ffd700;">&#39;s installed!
</span></code></pre>
<p>And when we run it:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ automated-rust-releases
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">Hello, world!
</span></code></pre>
<p>Beautiful!</p>
<hr />
<h2 id="conclusion-thinking">Conclusion 🤔</h2>
<p>I used this release automation for my latest project <a href="https://github.com/orhun/daktilo"><strong>daktilo</strong></a> (a CLI program to turn your keyboard into a typewriter) and I'm pretty satisfied with it so far. The only thing I'm waiting for is the following improvements:</p>
<ul>
<li><code>git-cliff</code>: better GitHub integration (i.e. adding contributor names to the changelogs <a href="https://github.com/orhun/git-cliff/issues/119">*</a>)</li>
<li><code>release-plz</code>: setting the version in the release PR with a command <a href="https://github.com/MarcoIeni/release-plz/issues/704">*</a></li>
<li><code>cargo-dist</code>: cross compilation <a href="https://github.com/axodotdev/cargo-dist/issues/74">*</a></li>
</ul>
<p>Let me know if you have suggestions and ideas!</p>
<p>Happy releasing! 🦀</p>
<p><em>houdoe!</em></p>
<hr />
<p>💖 Liked this article? Want to sponsor my blog posts and have early access? Want to add your company's badge / your logo here? Check out my <a href="https://github.com/sponsors/orhun">GitHub sponsorship tiers</a>!</p>

    </div>

    
        <footer>
            <hr>
            <p>
                
                    Published by Orhun Parmaksız
                
                
                    
                    in <a href="https://blog.orhun.dev/categories/rust/">Rust</a>
                
                
            </p>
            
            
            <div style="display: flex; justify-content: space-between; align-items: center">
              <div>
                <iframe
                  src="https://github.com/sponsors/orhun/button"
                  title="Sponsor @orhun"
                  height="35"
                  width="116"
                  style="border: 0"
                ></iframe>
                <a href="https://www.buymeacoffee.com/orhun" target="_blank"
                  ><img
                    src="https://cdn.buymeacoffee.com/buttons/v2/default-white.png"
                    alt="Buy Me A Coffee"
                    style="height: 40px !important; width: 150px !important"
                /></a>
              </div>
              <div>
                <applause-button
                  style="width: 50px; height: 50px"
                  url="https://blog.orhun.dev&#x2F;automated-rust-releases&#x2F;"
                  color="white"
                  multiclap="true"
                />
              </div>
              <div>
                <div style="width: auto; height: 39px">
                  <p style="margin: 0; color: #fff; font-style: italic">✨ Sponsored by:</p>
                </div>
                <a href="https://www.jetbrains.com/" target="_blank"
                  ><img
                    src="/sponsors/jetbrains.png"
                    alt="JetBrains"
                    style="height: 45px; width: auto"
                /></a>
                <a href="https://terminaltrove.com/" target="_blank"
                  ><img
                    src="/sponsors/terminal_trove.png"
                    alt="Terminal Trove"
                    style="height: 40px; width: auto"
                /></a>
                <a href="https://rawkode.academy/" target="_blank"
                  ><img
                    src="/sponsors/rawkode_academy.png"
                    alt="Rawkode Academy"
                    style="height: 40px; width: auto"
                /></a>
              </div>
            </div>
            <script src="https://utteranc.es/client.js"
                    repo="orhun/personal-blog"
                    issue-term="url"
                    label="comments"
                    theme="github-dark"
                    crossorigin="anonymous"
                    async>
            </script>
        </footer>
    
</article>


    </body>

    <script type="text/javascript" src="https://blog.orhun.dev/elasticlunr.min.js"></script>
    <script type="text/javascript" src="https://blog.orhun.dev/js/search.js"></script>

</html>
